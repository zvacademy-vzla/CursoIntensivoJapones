<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curso Intensivo de Japon√©s para la Salud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos personalizados para transiciones suaves y el estado colapsado */
        body {
            font-family: 'Inter', sans-serif;
            padding-top: 80px; /* Espacio para el header fijo */
        }

        /* Aplica transici√≥n a la barra lateral y al contenido principal */
        #sidebar, #main-content-area {
            transition: width 0.3s ease-in-out, margin 0.3s ease-in-out, transform 0.3s ease-in-out;
        }

        /* Oculta los textos de las listas y otros elementos cuando el men√∫ est√° colapsado */
        .sidebar-collapsed .sidebar-text,
        .sidebar-collapsed #firebase-info {
            opacity: 0;
            width: 0;
            overflow: hidden;
            pointer-events: none;
            transition: opacity 0.1s;
        }

        /* Mantiene el padding y el logo visible, pero oculta el texto del t√≠tulo */
        .sidebar-collapsed #sidebar-title {
            opacity: 0;
            pointer-events: none;
            white-space: nowrap;
        }

        /* Asegura que los √≠conos de los elementos de la lista se centren cuando se colapsa */
        .sidebar-collapsed #topic-list .flex-1 {
            flex-grow: 0;
        }

        /* Animaci√≥n para el mensaje de estado */
        @keyframes bounce-slow {
            0%, 100% {
                transform: translateX(-50%) translateY(0);
            }
            50% {
                transform: translateX(-50%) translateY(-5px);
            }
        }
        .animate-bounce-slow {
            animation: bounce-slow 1.5s ease-in-out infinite;
        }

        /* ESTILOS DE BOT√ìN TIPO MANGA GENERAL */
        .manga-button {
            position: relative;
            transition: all 0.1s;
            transform: translate(0);
            border: 2px solid;
            font-weight: 900;
        }
        .manga-button:active {
            transform: translate(0.2rem, 0.2rem);
            box-shadow: 0 0 0 rgba(0,0,0,0) !important; /* Desactiva la sombra al hacer clic */
        }

        /* Estilos espec√≠ficos para cada bot√≥n manga */
        .manga-instagram {
            border-color: #4f46e5; /* Indigo */
            box-shadow: 0.5rem 0.5rem 0 #4f46e5;
        }
        .manga-classroom {
            border-color: #16a34a; /* Green 700 */
            box-shadow: 0.5rem 0.5rem 0 #16a34a;
        }
        .manga-duolingo {
            border-color: #f59e0b; /* Amber 500 */
            box-shadow: 0.5rem 0.5rem 0 #f59e0b;
        }

        /* Estilo para el modal */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.7);
        }
    </style>
    <script type="module">
        // Importaciones de Firebase (Aseg√∫rate de que estas URLs sean accesibles en tu entorno)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // Configuraciones de Firebase (Globales obligatorias en este entorno)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // ********************************************************************
        // ************ L√ìGICA DE RECUPERACI√ìN DE AUTENTICACI√ìN ***************
        // ********************************************************************
        // Usamos la configuraci√≥n y el token de la sesi√≥n almacenada en sessionStorage (del login)
        const firebaseConfig = JSON.parse(sessionStorage.getItem('firebaseConfig')) || (typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null);
        const sessionToken = sessionStorage.getItem('firebaseIdToken');
        const sessionUid = sessionStorage.getItem('firebaseUid');
        // Usamos el token de sesi√≥n si existe, sino, el token inicial/dummy
        const authToUse = sessionToken || (typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null);

        let db, auth;
        let userId = sessionUid || 'loading...'; // Usar UID de la sesi√≥n si existe, o 'loading...'
        let isSidebarExpanded = true; 

        // ====================================================================
        // 1. DATA: EL TEMARIO COMPLETO (Plan de estudios detallado para Fisioterapeuta)
        // ====================================================================
        window.SYLLABUS_DATA = [
            { 
                id: 'M1', 
                title: 'M√≥dulo 1: Fundamentos y Comunicaci√≥n Inicial (Nihongo Ny≈´mon)', 
                lessons: [
                    { 
                        id: 'CL0', title: 'Lecci√≥n Intro: Êó•Êú¨Ë™û„ÅÆÂÖ•ÈñÄ. ü´Ç', 
                        content: `<h4 class="text-xl font-semibold mt-3 text-indigo-700">Objetivo</h4><p>Familiarizarse con los sistemas de escritura y obtener una visi√≥n cultural.</p><h4 class="text-xl font-semibold mt-3 text-indigo-700">Contenido Clave</h4><ul class="list-disc list-inside ml-4 space-y-2 mt-2"><li>**Sistemas de escritura:** Repaso de Hiragana (fon√©tico) y Katakana (pr√©stamos).</li><li>**Kanji de inicio:** Êó•Êú¨ (Nihon - Jap√≥n), Ë™û (go - idioma), ÁßÅ (watashi - yo).</li><li>**Cultura:** Etiqueta del saludo, reverencias (ojigi) y principales atracciones tur√≠sticas.</li></ul><h4 class="text-xl font-semibold mt-3 text-indigo-700">Frases y Vocabulario</h4><p class="font-mono text-base">„ÅØ„Åò„ÇÅ„Åæ„Åó„Å¶ (Hajimemashite - Encantado de conocerle), Êó•Êú¨Ë™û (Nihongo - idioma japon√©s).</p>`,
                        quiz: [{ question: "¬øQu√© sistema de escritura se usa principalmente para palabras de origen extranjero?", options: ["Hiragana", "Kanji", "Katakana"], answer: 2 },{ question: "El kanji **ÁßÅ** significa:", options: ["Jap√≥n", "Yo", "Idioma"], answer: 1 }]
                    },
                    { 
                        id: 'CL1', title: 'Lecci√≥n 1: Saludos y Presentaciones üëã', 
                        content: `<h4 class="text-xl font-semibold mt-3 text-indigo-700">Objetivo</h4><p>Saber presentarse y establecer un primer contacto en diferentes contextos de formalidad.</p><h4 class="text-xl font-semibold mt-3 text-indigo-700">Vocabulario Clave</h4><ul class="list-disc list-inside ml-4 space-y-2 mt-2"><li>**Saludos:** „Åä„ÅØ„Çà„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô (Ohay≈ç gozaimasu - Buenos d√≠as), „Åì„Çì„Å´„Å°„ÅØ (Konnichiwa), „Åì„Çì„Å∞„Çì„ÅØ (Konbanwa).</li><li>**Profesi√≥n:** ÁêÜÂ≠¶ÁôÇÊ≥ïÂ£´ (Rigaku ry≈çh≈çshi - Fisioterapeuta), „Åä‰ªï‰∫ã (Oshigoto - Trabajo).</li></ul><h4 class="text-xl font-semibold mt-3 text-indigo-700">Estructura Gramatical</h4><p>F√≥rmula de presentaci√≥n: <code class="bg-gray-200 p-1 rounded font-mono">[Sujeto] „ÅØ [Profesi√≥n] „Åß„Åô„ÄÇ</code><br>(Ejemplo: ÁßÅ„ÅØÁêÜÂ≠¶ÁôÇÊ≥ïÂ£´„Åß„Åô„ÄÇ - Watashi wa rigaku ry≈çh≈çshi desu.)</p><h4 class="text-xl font-semibold mt-3 text-indigo-700">Frases Esenciales</h4><p class="font-mono text-base">„ÅäÂêçÂâç„ÅØÔºü (O-namae wa? - ¬øCu√°l es su nombre?), „Åä‰ªï‰∫ã„ÅØÔºü (O-shigoto wa? - ¬øCu√°l es su trabajo?).</p>`,
                        quiz: [{ question: "La forma m√°s formal de 'Buenos d√≠as' es:", options: ["„Åì„Çì„Å´„Å°„ÅØ", "„Åì„Çì„Å∞„Çì„ÅØ", "„Åä„ÅØ„Çà„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô"], answer: 2 },{ question: "¬øC√≥mo se dice 'fisioterapeuta' en japon√©s?", options: ["„ÅäÂåªËÄÖ„Åï„Çì", "ÁêÜÂ≠¶ÁôÇÊ≥ïÂ£´", "ÁúãË≠∑Â∏´"], answer: 1 }]
                    },
                    { 
                        id: 'CL2', title: 'Lecci√≥n 2: Frases Esenciales para el D√≠a a D√≠a üôè', 
                        content: `<h4 class="text-xl font-semibold mt-3 text-indigo-700">Objetivo</h4><p>Manejar situaciones de cortes√≠a, transacciones y solicitudes b√°sicas.</p><h4 class="text-xl font-semibold mt-3 text-indigo-700">Vocabulario y Frases Clave</h4><ul class="list-disc list-inside ml-4 space-y-2 mt-2"><li>**Cortes√≠a:** „ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô (Arigat≈ç gozaimasu - Gracias), „ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô (Onegai shimasu - Por favor), „Åî„ÇÅ„Çì„Å™„Åï„ÅÑ (Gomen nasai - Lo siento).</li><li>**Preguntar Ubicaci√≥n:** <code class="bg-gray-200 p-1 rounded font-mono">„Äú„ÅØ „Å©„Åì„Åß„Åô„ÅãÔºü</code> (Ej: Eki wa doko desu ka? - ¬øD√≥nde est√° la estaci√≥n?).</li><li>**Preguntar Precio:** „ÅÑ„Åè„Çâ„Åß„Åô„ÅãÔºü (Ikura desu ka? - ¬øCu√°nto cuesta?).</li></ul><h4 class="text-xl font-semibold mt-3 text-indigo-700">Indicaciones B√°sicas</h4><p class="font-mono text-base">„Åæ„Å£„Åô„ÅêË°å„Å£„Å¶„Åè„Å†„Åï„ÅÑ (Massugu itte kudasai - Vaya recto, por favor).</p>`,
                        quiz: [{ question: "¬øC√≥mo se pregunta '¬øCu√°nto cuesta?'?", options: ["„Å©„Åì„Åß„Åô„ÅãÔºü", "„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô„ÄÇ", "„ÅÑ„Åè„Çâ„Åß„Åô„ÅãÔºü"], answer: 2 },{ question: "La frase '„Åî„ÇÅ„Çì„Å™„Åï„ÅÑ' significa:", options: ["Gracias", "Por favor", "Lo siento / Disculpe"], answer: 2 }]
                    }
                ] 
            },
            { 
                id: 'M2', title: 'M√≥dulo 2: Vocabulario Cl√≠nico y Terapia', 
                lessons: [
                    { 
                        id: 'CL3', title: 'Lecci√≥n 3: Anatom√≠a y Descripci√≥n del Dolor ü¶¥üí™', 
                        content: `<h4 class="text-xl font-semibold mt-3 text-indigo-700">Objetivo</h4><p>Nombrar las partes principales del cuerpo y describir el dolor en japon√©s, esencial para la anamnesis.</p>
                        <h4 class="text-xl font-semibold mt-3 text-indigo-700">Partes del Cuerpo (‰Ωì„ÅÆÈÉ®ÂàÜ - karada no bubun)</h4>
                        <ul class="list-disc list-inside ml-4 space-y-2 mt-2 font-mono text-base bg-gray-100 p-3 rounded">
                            <li>Cabeza: <strong>È†≠</strong> (atama), Cuello: <strong>È¶ñ</strong> (kubi), Hombro: <strong>ËÇ©</strong> (kata)</li>
                            <li>Brazo/Codo/Mano: <strong>ËÖï</strong> (ude), <strong>ËÇò</strong> (hiji), <strong>Êâã</strong> (te)</li>
                            <li>Espalda/Pecho/Abdomen: <strong>ËÉå‰∏≠</strong> (senaka), <strong>ËÉ∏</strong> (mune), <strong>„ÅäËÖπ</strong> (onaka)</li>
                            <li>Cadera/Pierna/Rodilla/Pie: <strong>ËÖ∞</strong> (koshi), <strong>Ë∂≥</strong> (ashi), <strong>ËÜù</strong> (hiza)</li>
                        </ul>
                        <h4 class="text-xl font-semibold mt-3 text-indigo-700">Estructuras Especializadas (Èñ¢ÁØÄ„Å®È™®)</h4>
                        <ul class="list-disc list-inside ml-4 space-y-2 mt-2 font-mono text-base">
                            <li>Articulaci√≥n: <strong>Èñ¢ÁØÄ</strong> (kansetsu), Hueso: <strong>È™®</strong> (hone)</li>
                            <li>Columna vertebral: <strong>ËÉåÈ™®</strong> (sebone)</li>
                            <li>V√©rtebra cervical/lumbar: <strong>È†∏Ê§é</strong> (keitsui), <strong>ËÖ∞Ê§é</strong> (y≈çtsui)</li>
                            <li>M√∫sculo/Nervio/Tend√≥n/Ligamento: <strong>Á≠ãËÇâ</strong> (kin'niku), <strong>Á•ûÁµå</strong> (shinkei), <strong>ËÖ±</strong> (ken), <strong>Èù≠Â∏Ø</strong> (jintai)</li>
                        </ul>
                        <h4 class="text-xl font-semibold mt-3 text-indigo-700">Expresar el Dolor y Sensaciones</h4>
                        <p class="font-semibold text-gray-700">F√≥rmula clave: <code class="bg-indigo-100 p-1 rounded font-mono">[Parte del cuerpo] „Åå Áóõ„ÅÑ„Åß„Åô„ÄÇ</code> (Ej: Koshi ga itai desu - Me duele la cadera)</p>
                        <ul class="list-disc list-inside ml-4 space-y-2 mt-2 font-mono text-base">
                            <li>Dolor: <strong>Áóõ„Åø</strong> (itami), ¬øD√≥nde le duele?: <strong>„Å©„Åì„Åå Áóõ„ÅÑ„Åß„Åô„ÅãÔºü</strong> (Doko ga itai desu ka?)</li>
                            <li>Hormigueo: <strong>Áó∫„Çå</strong> (shibire), Adormecimiento: <strong>È∫ªÁó∫</strong> (mahi)</li>
                            <li>Intensidad: <strong>Áóõ„Åø„ÅåÂº∑„ÅÑ„Åß„Åô / ËªΩ„ÅÑ„Åß„Åô„ÄÇ</strong> (Dolor intenso / leve)</li>
                        </ul>`,
                        quiz: [
                            { question: "¬øCu√°l es el kanji para 'M√∫sculo'?", options: ["È™®", "Á•ûÁµå", "Á≠ãËÇâ"], answer: 2 },
                            { question: "La frase **Áó∫„Çå** (shibire) significa:", options: ["Dolor intenso", "Hormigueo", "Adormecimiento"], answer: 1 },
                            { question: "La rodilla en japon√©s es:", options: ["ËÇ© (kata)", "ËÇò (hiji)", "ËÜù (hiza)"], answer: 2 }
                        ]
                    },
                    { 
                        id: 'CL4', title: 'Lecci√≥n 4: La Consulta con el Paciente ü©∫', 
                        content: `Contenido bloqueado: ¬°Completa la lecci√≥n anterior!`,
                        quiz: []
                    },
                    { 
                        id: 'CL5', title: 'Lecci√≥n 5: Instrucciones y ejercicios üèãÔ∏è‚Äç‚ôÄÔ∏è', 
                        content: `Contenido bloqueado: ¬°Completa la lecci√≥n anterior!`,
                        quiz: []
                    }
                ] 
            },
            { 
                id: 'M3', title: 'M√≥dulo 3: Vida Social y Cotidiana', 
                lessons: [
                    { 
                        id: 'CL6', title: 'Lecci√≥n 6: En la Calle y el Transporte üöâüó∫Ô∏è', 
                        content: `Contenido bloqueado: ¬°Completa la lecci√≥n anterior!`,
                        quiz: []
                    },
                    { 
                        id: 'CL7', title: 'Lecci√≥n 7: En Restaurantes y Tiendas üç£üõçÔ∏è', 
                        content: `Contenido bloqueado: ¬°Completa la lecci√≥n anterior!`,
                        quiz: []
                    },
                    { 
                        id: 'CL8', title: 'Lecci√≥n 8: Vivienda y servicios üè°üí°', 
                        content: `Contenido bloqueado: ¬°Completa la lecci√≥n anterior!`,
                        quiz: []
                    },
                    { 
                        id: 'CL9', title: 'Lecci√≥n 9: Emergencias y problemas üö®üöë', 
                        content: `Contenido bloqueado: ¬°Completa la lecci√≥n anterior!`,
                        quiz: []
                    },
                     { 
                        id: 'CL10', title: 'Lecci√≥n 10: Conversaci√≥n informal y vida social üó£Ô∏èüòä', 
                        content: `Contenido bloqueado: ¬°Completa la lecci√≥n anterior!`,
                        quiz: []
                    }
                ] 
            },
            {
                id: 'M4', title: 'M√≥dulo 4: Repaso y Simulaci√≥n Avanzada',
                lessons: [
                    {
                        id: 'CL11', title: 'Lecci√≥n 11: Repaso y Pr√°ctica de Roles üó£Ô∏è‚úÖ',
                        content: `Contenido bloqueado: ¬°Completa la lecci√≥n anterior!`,
                        quiz: []
                    }
                ]
            }
        ];

        // ====================================================================
        // 2. STATE (ESTADO) y FIREBASE (L√≥gica de Persistencia y Vidas/Gemas)
        // ====================================================================
        let currentTopicId = null;
        let practicedTopics = new Set();
        let currentLessonQuiz = [];
        let quizCompleted = false;

        let userGems = 0;
        let userLives = 5;
        
        // ID de la √∫ltima lecci√≥n accesible (CL3)
        const LAST_ACCESSIBLE_LESSON_ID = 'CL3'; 

        // Devuelve la referencia al documento Firestore para el progreso del usuario
        function getDocRef(db, userId) {
            return doc(db, 'artifacts', appId, 'users', userId, 'japanese_progress', 'practiced');
        }

        function getSequentialLessonList() {
             return window.SYLLABUS_DATA.flatMap(module => module.lessons);
        }

        // Determina la siguiente lecci√≥n que NO ha sido practicada (con bloqueo)
        function findNextLessonId() {
            const allLessons = getSequentialLessonList();
            for (const lesson of allLessons) {
                if (!practicedTopics.has(lesson.id)) {
                    // Si la lecci√≥n est√° despu√©s del l√≠mite, devuelve el l√≠mite como la √∫ltima accesible
                    if (allLessons.findIndex(l => l.id === lesson.id) > allLessons.findIndex(l => l.id === LAST_ACCESSIBLE_LESSON_ID) && !practicedTopics.has(LAST_ACCESSIBLE_LESSON_ID)) {
                        return LAST_ACCESSIBLE_LESSON_ID; 
                    }
                    return lesson.id;
                }
            }
             // Si todo est√° completado hasta el l√≠mite, devuelve el l√≠mite (CL3)
            return LAST_ACCESSIBLE_LESSON_ID;
        }

        // Determina si una lecci√≥n es accesible (o si ya est√° practicada)
        function isLessonAccessible(lessonId) {
            const allLessons = getSequentialLessonList();
            const lessonIndex = allLessons.findIndex(l => l.id === lessonId);
            const limitIndex = allLessons.findIndex(l => l.id === LAST_ACCESSIBLE_LESSON_ID);

            // 1. Si ya est√° practicada, es accesible para repaso.
            if (practicedTopics.has(lessonId)) {
                return true;
            }

            // 2. Si est√° dentro o en el l√≠mite (CL3), comprobamos el orden secuencial
            if (lessonIndex <= limitIndex) {
                // Si es la primera lecci√≥n, es accesible
                if (lessonIndex === 0) return true;
                
                // Si la lecci√≥n anterior ya est√° practicada, es accesible
                const prevLessonId = allLessons[lessonIndex - 1].id;
                return practicedTopics.has(prevLessonId);
            }

            // 3. Si est√° despu√©s del l√≠mite (CL4 en adelante), no es accesible si el l√≠mite no ha sido practicado.
            if (lessonIndex > limitIndex) {
                 // Si CL3 (el l√≠mite) NO ha sido practicado, bloquea todo despu√©s de CL3.
                 if (!practicedTopics.has(LAST_ACCESSIBLE_LESSON_ID)) {
                     return false;
                 } else {
                     // Si CL3 ya est√° practicado, comprobamos el orden secuencial normalmente.
                     const prevLessonId = allLessons[lessonIndex - 1].id;
                     return practicedTopics.has(prevLessonId);
                 }
            }
            return false; // Por defecto, si no cumple ninguna condici√≥n
        }
        
        async function initFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config not available. Using local storage fallback.");
                document.getElementById('firebase-status').textContent = '‚ö†Ô∏è Local Storage';
                document.getElementById('firebase-status').classList.add('text-yellow-600');
                loadProgressFromLocal();
                return;
            }

            try {
                setLogLevel('Debug');
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Usar el token recuperado de sessionStorage o el inicial/dummy.
                if (authToUse) {
                    await signInWithCustomToken(auth, authToUse);
                    document.getElementById('firebase-status').textContent = 'Conectado (Token Personalizado)';
                } else {
                    await signInAnonymously(auth);
                    document.getElementById('firebase-status').textContent = 'Conectado (An√≥nimo)';
                }

                userId = auth.currentUser?.uid || 'anon_' + crypto.randomUUID();
                document.getElementById('user-id-display').textContent = `ID de Usuario: ${userId}`;
                document.getElementById('firebase-status').classList.add('text-green-600');

                const docRef = getDocRef(db, userId);
                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        practicedTopics = new Set(data.topics || []);
                        userGems = data.gems !== undefined ? data.gems : 0;
                        userLives = data.lives !== undefined ? data.lives : 5;
                        console.log("Progreso cargado/actualizado desde Firestore.");
                    } else {
                        console.log("Documento de progreso no existe. Creando uno nuevo con valores iniciales.");
                        saveProgress(); 
                    }

                    renderSyllabus();
                    renderLearningPath();
                    if (currentTopicId) {
                        loadTopic(currentTopicId, true);
                    }
                }, (error) => {
                    console.error("Error al escuchar el progreso de Firestore:", error);
                    document.getElementById('firebase-status').textContent = 'Error de conexi√≥n';
                    document.getElementById('firebase-status').classList.add('text-red-600');
                });

            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
                document.getElementById('firebase-status').textContent = 'Error FATAL de Firebase';
                document.getElementById('firebase-status').classList.add('text-red-600');
            }
        }
        
        async function saveProgress() {
            if (!db || !userId) {
                saveProgressToLocal();
                return;
            }

            try {
                const docRef = getDocRef(db, userId);
                await setDoc(docRef, { 
                    topics: Array.from(practicedTopics), 
                    gems: userGems, 
                    lives: userLives,
                    lastUpdated: new Date() 
                }, { merge: true });
                console.log("Progreso (incluyendo gemas/vidas) guardado autom√°ticamente en Firestore.");
            } catch (error) {
                console.error("Error guardando progreso en Firestore:", error);
            }
        }
        
        // ====================================================================
        // 2.1. L√ìGICA DE CIERRE DE SESI√ìN
        // ====================================================================
        
        function logout() {
            // 1. Limpiar el almacenamiento de la sesi√≥n
            sessionStorage.removeItem('firebaseIdToken');
            sessionStorage.removeItem('firebaseUid');
            sessionStorage.removeItem('firebaseConfig');

            // 2. Cerrar la sesi√≥n de Firebase (opcional, si el usuario no es an√≥nimo)
            if (auth) {
                auth.signOut().catch(e => console.error("Error al cerrar sesi√≥n de Firebase:", e));
            }

            // 3. Recargar la p√°gina para volver al estado de "no logueado" o an√≥nimo.
            window.location.reload(); 
        }

        // Fallback a Local Storage (si Firebase no est√° disponible)
        function loadProgressFromLocal() {
            try {
                const storedProgress = localStorage.getItem('japaneseSyllabusProgress');
                if (storedProgress) {
                    const data = JSON.parse(storedProgress);
                    practicedTopics = new Set(data.topics || []);
                    userGems = data.gems !== undefined ? data.gems : 0;
                    userLives = data.lives !== undefined ? data.lives : 5;
                    console.log("Progreso cargado desde Local Storage.");
                    renderSyllabus();
                    renderLearningPath();
                }
            } catch (error) {
                console.error("Error cargando el progreso local:", error);
            }
        }

        function saveProgressToLocal() {
             try {
                localStorage.setItem('japaneseSyllabusProgress', JSON.stringify({
                    topics: Array.from(practicedTopics),
                    gems: userGems,
                    lives: userLives
                }));
                renderSyllabus();
                renderLearningPath();
            } catch (error) {
                console.error("Error guardando el progreso local:", error);
            }
        }

        // ====================================================================
        // 3. L√ìGICA DEL SIDEBAR DESPLEGABLE 
        // ====================================================================
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContentArea = document.getElementById('main-content-area');
            const toggleIcon = document.getElementById('toggle-icon');
            const appContainer = document.getElementById('app');

            isSidebarExpanded = !isSidebarExpanded;

            if (window.innerWidth < 768) {
                // Modo M√≥vil: Overlay
                sidebar.classList.toggle('-translate-x-full');
            } else {
                // Modo Escritorio: Colapsar/Expandir
                appContainer.classList.toggle('sidebar-collapsed', !isSidebarExpanded);
                
                if (isSidebarExpanded) {
                    sidebar.classList.remove('w-20');
                    sidebar.classList.add('w-80');
                    mainContentArea.classList.remove('md:ml-20');
                    mainContentArea.classList.add('md:ml-80');
                    toggleIcon.classList.remove('rotate-180');
                } else {
                    sidebar.classList.remove('w-80');
                    sidebar.classList.add('w-20');
                    mainContentArea.classList.remove('md:ml-80');
                    mainContentArea.classList.add('md:ml-20');
                    toggleIcon.classList.add('rotate-180');
                }
            }
        }

        function initialSidebarSetup() {
            const sidebar = document.getElementById('sidebar');
            const mainContentArea = document.getElementById('main-content-area');
            const appContainer = document.getElementById('app');

            if (window.innerWidth < 768) {
                // M√≥vil: Asegurar que est√© colapsado y sea overlay
                isSidebarExpanded = false;
                sidebar.classList.add('w-80', 'fixed', '-translate-x-full');
                sidebar.classList.remove('w-20', 'md:relative', 'md:translate-x-0');
                mainContentArea.classList.remove('md:ml-80', 'md:ml-20');
                appContainer.classList.remove('sidebar-collapsed');
            } else {
                // Escritorio: Asegurar estado inicial de w-80 y margen ml-80
                isSidebarExpanded = true;
                sidebar.classList.add('w-80', 'md:relative', 'md:translate-x-0');
                sidebar.classList.remove('w-20', 'fixed', '-translate-x-full');
                mainContentArea.classList.add('md:ml-80');
                mainContentArea.classList.remove('md:ml-20');
                appContainer.classList.remove('sidebar-collapsed');
            }
        }

        // ====================================================================
        // 4. RENDERIZADO DEL MAPA VISUAL Y COMPONENTES
        // ====================================================================

        function renderSyllabus() {
            // Actualiza el sidebar (√≠ndice) y el header gamificado
            const topicList = document.getElementById('topic-list');
            topicList.innerHTML = ''; 

            window.SYLLABUS_DATA.forEach(module => {
                const moduleHeader = document.createElement('h3');
                moduleHeader.className = 'sidebar-text text-lg font-bold text-gray-700 mt-4 mb-2 border-l-4 border-indigo-500 pl-2 transition-opacity duration-300';
                moduleHeader.textContent = module.title;
                topicList.appendChild(moduleHeader);

                const lessonList = document.createElement('ul');
                lessonList.className = 'space-y-1 mb-4';

                module.lessons.forEach(lesson => {
                    const isPracticed = practicedTopics.has(lesson.id);
                    const isAccessible = isLessonAccessible(lesson.id);

                    const listItem = document.createElement('li');
                    listItem.className = `p-2 rounded-lg transition-colors duration-200 flex items-center justify-between text-sm ${currentTopicId === lesson.id ? 'bg-indigo-100 font-semibold shadow-inner' : 'text-gray-700 hover:bg-indigo-50'} ${isAccessible ? 'cursor-pointer' : 'cursor-not-allowed opacity-50'}`;
                    
                    if (isAccessible) {
                        listItem.onclick = () => loadTopic(lesson.id);
                    } else {
                         listItem.onclick = () => showMessage('Lecci√≥n bloqueada. Debes completar la anterior o no tienes acceso a este m√≥dulo a√∫n.', 'error');
                    }

                    listItem.title = lesson.title; // T√≠tulo visible al hacer hover en modo colapsado

                    let iconSvg = '';
                    if (isPracticed) {
                        iconSvg = `<path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm13.36-1.814a.75.75 0 10-1.22-.872l-3.236 4.532a.75.75 0 001.144.945l3.879-5.433z" clip-rule="evenodd" />`;
                    } else if (isAccessible) {
                         iconSvg = `<path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.47 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm-.53 14.34a.75.75 0 001.06 0l3-3a.75.75 0 10-1.06-1.06l-2.47 2.47-1.47-1.47a.75.75 0 00-1.06 1.06l2 2z" clip-rule="evenodd" />`;
                    } else {
                        iconSvg = `<path fill-rule="evenodd" d="M12 1.5a5.25 5.25 0 00-5.25 5.25v3a5.25 5.25 0 0010.5 0v-3c0-2.9-2.35-5.25-5.25-5.25zm-3.75 8.25v-3c0-2.07 1.68-3.75 3.75-3.75s3.75 1.68 3.75 3.75v3h-7.5zM19.5 10.5a1.5 1.5 0 00-1.5 1.5v6a1.5 1.5 0 001.5 1.5h-15a1.5 1.5 0 00-1.5-1.5v-6a1.5 1.5 0 001.5-1.5h15z" clip-rule="evenodd" />`;
                    }


                    listItem.innerHTML = `
                        <span class="flex items-center space-x-2">
                             <span class="ml-1 ${isPracticed ? 'text-green-500' : (isAccessible ? 'text-indigo-500' : 'text-gray-400')}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor">
                                    ${iconSvg}
                                </svg>
                            </span>
                            <span class="sidebar-text flex-1 truncate transition-opacity duration-300">${lesson.title}</span>
                        </span>`;
                    lessonList.appendChild(listItem);
                });
                topicList.appendChild(lessonList);
            });
            
            document.getElementById('gems-count').textContent = userGems;
            document.getElementById('lives-count').textContent = userLives;
        }

        function renderLearningPath() {
            currentTopicId = currentTopicId || findNextLessonId();
            const allLessons = getSequentialLessonList().reverse(); 
            const mainContent = document.getElementById('main-content-wrapper');
            const nextLessonId = findNextLessonId();

            mainContent.innerHTML = '';
            mainContent.classList.add('flex', 'flex-col', 'items-center', 'justify-start', 'relative', 'min-h-[80vh]');
            mainContent.style.backgroundImage = 'radial-gradient(circle at center, #e0f2fe 0%, #ffffff 100%)';
            mainContent.style.paddingTop = '1rem';
            mainContent.style.paddingBottom = '10rem';
            
            const pathHeader = document.createElement('h2');
            pathHeader.className = 'text-3xl font-bold text-gray-800 mb-8 border-b-2 border-indigo-400 pb-1 z-10';
            pathHeader.textContent = 'Tu Camino de Aprendizaje Japon√©s PRO';
            mainContent.appendChild(pathHeader);

            const pathContainer = document.createElement('div');
            pathContainer.className = 'relative w-full max-w-sm';
            
            const line = document.createElement('div');
            line.className = 'absolute top-0 bottom-0 left-1/2 -translate-x-1/2 w-2 bg-indigo-200 rounded-full shadow-inner';
            pathContainer.appendChild(line);

            allLessons.forEach((lesson, index) => {
                const isPracticed = practicedTopics.has(lesson.id);
                const isCurrent = lesson.id === nextLessonId && !isPracticed; // Solo es 'current' si no est√° practicada.
                const isAccessible = isLessonAccessible(lesson.id);

                const offset = index % 2 === 0 ? 'left-[calc(50%+1rem)]' : 'right-[calc(50%+1rem)]'; 
                
                let color, innerIcon;
                let pulse = '';

                if (isPracticed) {
                    color = 'bg-green-500';
                    innerIcon = `‚úÖ`;
                } else if (isCurrent && isAccessible) {
                    color = 'bg-indigo-500';
                    innerIcon = `üìö`;
                    pulse = 'animate-pulse ring-4 ring-indigo-300 ring-opacity-50';
                } else {
                    color = 'bg-gray-400';
                    innerIcon = `üîí`;
                }

                const cursor = isAccessible ? 'cursor-pointer' : 'cursor-not-allowed';
                
                const nodeWrapper = document.createElement('div');
                nodeWrapper.className = `absolute w-16 h-16 transform -translate-x-1/2 -translate-y-1/2 ${offset} z-20 transition-all duration-500`;
                nodeWrapper.style.top = `${allLessons.length * 120 - index * 120 + 80}px`; // Invertir orden

                const node = document.createElement('div');
                node.className = `w-16 h-16 rounded-full flex items-center justify-center text-white text-3xl font-bold shadow-lg transition-all duration-300 ${color} ${pulse} ${cursor}`;
                node.title = `${lesson.title.split(':')[0]} (${isPracticed ? 'Completada' : (isCurrent ? 'Actual' : (isAccessible ? 'Pendiente' : 'Bloqueada'))})`;

                if (isAccessible) {
                    node.innerHTML = innerIcon;
                    node.onclick = () => loadTopic(lesson.id);
                } else {
                    node.innerHTML = innerIcon;
                    node.onclick = () => showMessage('Lecci√≥n bloqueada. Completa la lecci√≥n anterior o no tienes acceso a este m√≥dulo a√∫n.', 'error');
                }

                const label = document.createElement('span');
                const labelOffset = index % 2 === 0 ? '-left-24 text-right' : 'left-24 text-left';
                label.className = `absolute top-1/2 -translate-y-1/2 w-24 text-sm font-semibold text-gray-700 ${labelOffset} ${isCurrent ? 'text-indigo-600' : ''}`;
                label.textContent = lesson.title.split(':')[0];

                node.appendChild(label);
                nodeWrapper.appendChild(node);
                pathContainer.appendChild(nodeWrapper);
            });

            const totalHeight = allLessons.length * 120 + 100;
            pathContainer.style.height = `${totalHeight}px`;

            mainContent.appendChild(pathContainer);
        }


        // ====================================================================
        // 5. L√ìGICA DE INTERACCI√ìN Y QUIZ
        // ====================================================================

        function findLessonById(id) {
            for (const module of window.SYLLABUS_DATA) {
                const lesson = module.lessons.find(l => l.id === id);
                if (lesson) return lesson;
            }
            return null;
        }

        function loadTopic(topicId, isUpdate = false) {
            const lesson = findLessonById(topicId);
            const headerElement = document.getElementById('header-title');
            const mainContent = document.getElementById('main-content-wrapper');
            const practiceButton = document.getElementById('practice-button');
            
            // Comprobaci√≥n de Acceso
             if (!isLessonAccessible(topicId)) {
                showMessage('Lecci√≥n bloqueada. Debes completar la lecci√≥n anterior o no tienes acceso a este m√≥dulo a√∫n.', 'error');
                renderLearningPath();
                return;
            }
            
            if (!isUpdate) {
                // Si es m√≥vil, colapsamos el men√∫ al cargar una lecci√≥n
                if (window.innerWidth < 768 && isSidebarExpanded) {
                    toggleSidebar(); 
                }
                currentTopicId = topicId;
                quizCompleted = false; 
            }
           
            if (!lesson) {
                renderLearningPath();
                return;
            }

            renderSyllabus(); 
            
            const moduleContainer = window.SYLLABUS_DATA.find(m => m.lessons.some(l => l.id === topicId));
            currentLessonQuiz = lesson.quiz;

            headerElement.textContent = `${moduleContainer.title.split(':')[0]} - ${lesson.title.split(':')[0]}`;

            mainContent.innerHTML = `
                <div class="max-w-4xl mx-auto w-full">
                    <header class="mb-8">
                        <h1 class="text-3xl font-bold text-indigo-700 mb-2">${lesson.title}</h1>
                        <p class="text-lg text-gray-600">Revisa el contenido y prep√°rate para el quiz.</p>
                    </header>

                    <section id="content-body" class="bg-white p-6 md:p-8 rounded-xl shadow-xl transition-opacity duration-300">
                    </section>
                    
                    <section id="quiz-area" class="bg-white p-6 md:p-8 rounded-xl shadow-xl transition-opacity duration-300 mt-8">
                    </section>
                </div>
            `;
            
            document.getElementById('content-body').innerHTML = `
                <div class="space-y-6">
                    <h3 class="text-2xl font-semibold text-gray-800">Contenido Clave</h3>
                    <div class="text-gray-700 leading-relaxed p-4 bg-gray-50 border-l-4 border-indigo-400 rounded-lg">
                        ${lesson.content}
                    </div>
                </div>
            `;

            // Si hay quiz, lo renderiza, si no, oculta el bot√≥n de pr√°ctica inicialmente
            if (currentLessonQuiz && currentLessonQuiz.length > 0) {
                renderQuiz();
                practiceButton.classList.remove('hidden');
            } else {
                 document.getElementById('quiz-area').innerHTML = `
                    <p class="text-lg text-red-500 font-semibold p-4 bg-red-50 rounded-lg">Esta lecci√≥n no tiene un quiz asociado o est√° bloqueada.</p>
                 `;
                 practiceButton.classList.add('hidden');
            }

            updatePracticeButtonState(topicId);
        }

        function renderQuiz() {
            const quizArea = document.getElementById('quiz-area');
            quizArea.innerHTML = `
                <h3 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 mt-8">Quiz de Pr√°ctica (Gana 5 Gemas por acierto)</h3>
                <div id="quiz-questions" class="space-y-6">
                    </div>
                <div id="quiz-feedback" class="mt-6 p-4 rounded-lg hidden"></div>
                <button onclick="checkQuiz()" id="check-quiz-button" class="mt-6 w-full px-4 py-2 bg-indigo-500 text-white font-semibold rounded-lg hover:bg-indigo-600 transition-colors">
                    Verificar Respuestas
                </button>
                <button onclick="skipQuiz()" id="skip-quiz-button" class="mt-3 w-full px-4 py-2 text-gray-500 font-semibold rounded-lg hover:bg-gray-100 transition-colors">
                    Saltar Quiz (Riesgo de perder Vidas)
                </button>
            `;

            const questionsContainer = document.getElementById('quiz-questions');
            currentLessonQuiz.forEach((q, index) => {
                const qDiv = document.createElement('div');
                qDiv.className = 'bg-gray-50 p-4 rounded-lg shadow-sm';
                qDiv.innerHTML = `
                    <p class="font-semibold text-gray-700 mb-3">${index + 1}. ${q.question}</p>
                    <div class="space-y-2" id="options-${index}">
                        ${q.options.map((option, oIndex) => `
                            <label class="flex items-center space-x-2 cursor-pointer p-2 rounded-md hover:bg-white transition-colors">
                                <input type="radio" name="question-${index}" value="${oIndex}" class="form-radio text-indigo-600">
                                <span class="text-gray-600">${option}</span>
                            </label>
                        `).join('')}
                    </div>
                    <div id="result-${index}" class="mt-2 text-sm font-medium hidden"></div>
                `;
                questionsContainer.appendChild(qDiv);
            });
        }

        function checkQuiz() {
            let correctAnswers = 0;
            const totalQuestions = currentLessonQuiz.length;
            let firstIncorrect = false;

            currentLessonQuiz.forEach((q, index) => {
                const selectedOption = document.querySelector(`input[name="question-${index}"]:checked`);
                const resultDiv = document.getElementById(`result-${index}`);
                const optionsDiv = document.getElementById(`options-${index}`);

                if (resultDiv && optionsDiv) {
                    optionsDiv.querySelectorAll('label').forEach(label => label.classList.remove('bg-green-100', 'bg-red-100'));
                    resultDiv.classList.remove('hidden', 'text-green-600', 'text-red-600');

                    if (selectedOption && parseInt(selectedOption.value) === q.answer) {
                        correctAnswers++;
                        resultDiv.textContent = '¬°Correcto! (+5 Gemas)';
                        resultDiv.classList.add('text-green-600');
                        selectedOption.closest('label').classList.add('bg-green-100');
                        userGems += 5; // Gana 5 Gemas por acierto individual
                    } else {
                        resultDiv.textContent = 'Incorrecto. La respuesta correcta es: ' + q.options[q.answer];
                        resultDiv.classList.add('text-red-600');
                        
                        if (selectedOption) {
                            selectedOption.closest('label').classList.add('bg-red-100');
                        }
                        
                        // Solo aplica la penalizaci√≥n de vida una vez por intento de quiz
                        if (!firstIncorrect) {
                            if (userLives > 0) {
                                userLives--;
                                showMessage('¬°Respuesta incorrecta! Has perdido 1 Vida. Vidas restantes: ' + userLives, 'error');
                            } else {
                                showMessage('¬°Te has quedado sin Vidas! Practica m√°s antes de continuar.', 'error');
                            }
                            document.getElementById('lives-count').textContent = userLives;
                            saveProgress(); 
                            firstIncorrect = true;
                        }
                    }
                }
            });

            const feedbackDiv = document.getElementById('quiz-feedback');
            const checkButton = document.getElementById('check-quiz-button');
            
            feedbackDiv.classList.remove('hidden', 'bg-red-100', 'bg-green-100');
            feedbackDiv.classList.add('p-4', 'font-bold');
            
            saveProgress(); // Guarda las gemas/vidas

            if (correctAnswers === totalQuestions) {
                feedbackDiv.textContent = `¬°Felicidades! Has completado el quiz con ${correctAnswers}/${totalQuestions} aciertos y ganado ${totalQuestions * 5} Gemas üíé. Puedes marcar la lecci√≥n.`;
                feedbackDiv.classList.add('bg-green-100', 'text-green-700');
                quizCompleted = true;
                checkButton.disabled = true;
                checkButton.textContent = 'Quiz Completado';
            } else {
                feedbackDiv.textContent = `Resultado: ${correctAnswers}/${totalQuestions} aciertos. Sigue practicando.`;
                feedbackDiv.classList.add('bg-red-100', 'text-red-700');
                quizCompleted = false;
            }

            updatePracticeButtonState(currentTopicId);
        }

        function skipQuiz() {
            const feedbackDiv = document.getElementById('quiz-feedback');
            feedbackDiv.classList.remove('hidden', 'bg-red-100', 'bg-green-100');
            feedbackDiv.classList.add('bg-yellow-100', 'text-yellow-700', 'p-4', 'font-bold');
            feedbackDiv.textContent = 'Has saltado el quiz. ¬°No hay Gemas por saltar!';
            quizCompleted = true; // Permite marcar aunque se haya saltado

            updatePracticeButtonState(currentTopicId);
        }

        function updatePracticeButtonState(topicId) {
            const practiceButton = document.getElementById('practice-button');
            const isPracticed = practicedTopics.has(topicId);

            if (isPracticed) {
                practiceButton.disabled = true;
                practiceButton.textContent = '¬°Lecci√≥n Practicada! ‚úÖ';
                practiceButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700', 'bg-red-600', 'hover:bg-red-700');
                practiceButton.classList.add('bg-green-600', 'hover:bg-green-700');
                practiceButton.onclick = null;
                return;
            }

            if (userLives <= 0) {
                 practiceButton.disabled = true;
                 practiceButton.textContent = 'Vidas Agotadas. Recarga para continuar.';
                 practiceButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700', 'bg-red-600', 'hover:bg-red-700');
                 practiceButton.classList.add('bg-gray-400');
                 practiceButton.onclick = () => showMessage('¬°Necesitas Gemas para recargar una Vida!', 'error'); 
                 return;
            }

            if (quizCompleted) {
                practiceButton.disabled = false;
                practiceButton.textContent = 'Marcar Lecci√≥n como Practicada (Ganas 10 Gemas)';
                practiceButton.classList.remove('bg-gray-400', 'bg-red-600', 'hover:bg-red-700');
                practiceButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                practiceButton.onclick = () => markAsPracticed(topicId);
            } else {
                practiceButton.disabled = true;
                practiceButton.textContent = 'Completa el Quiz para Practicar';
                practiceButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700', 'bg-red-600', 'hover:bg-red-700');
                practiceButton.classList.add('bg-gray-400');
                practiceButton.onclick = null;
            }
        }


        function markAsPracticed(topicId) {
            if (!practicedTopics.has(topicId)) {
                practicedTopics.add(topicId);
                userGems += 10; // 10 Gemas adicionales por completar la lecci√≥n
                saveProgress();
                showMessage('¬°Lecci√≥n completada! Has ganado 10 Gemas adicionales üíé.', 'success');
                
                // Carga la siguiente lecci√≥n
                const allLessons = getSequentialLessonList();
                const currentLessonIndex = allLessons.findIndex(l => l.id === topicId);

                if (currentLessonIndex < allLessons.length - 1) {
                    const nextLessonId = allLessons[currentLessonIndex + 1].id;
                    // Retrasamos la carga para que el usuario vea el mensaje de √©xito
                    setTimeout(() => {
                        loadTopic(nextLessonId);
                    }, 2500);
                } else {
                    renderLearningPath(); // Vuelve al mapa si es la √∫ltima lecci√≥n.
                }
            }
            updatePracticeButtonState(topicId);
            renderSyllabus(); 
        }

        function showMessage(message, type = 'info') {
            const messageBar = document.getElementById('message-bar');
            messageBar.textContent = message;
            messageBar.classList.remove('hidden', 'bg-green-500', 'bg-red-500', 'bg-yellow-500', 'animate-bounce-slow');

            if (type === 'success') {
                messageBar.classList.add('bg-green-500');
            } else if (type === 'error') {
                messageBar.classList.add('bg-red-500', 'animate-bounce-slow');
            } else {
                messageBar.classList.add('bg-yellow-500');
            }

            // Ocultar despu√©s de 5 segundos
            setTimeout(() => {
                messageBar.classList.add('hidden');
            }, 5000);
        }

        // ====================================================================
        // 6. L√ìGICA DE LA TIENDA DE VIDAS
        // ====================================================================

        function openShopModal() {
            document.getElementById('shop-modal').classList.remove('hidden');
        }

        function closeShopModal() {
            document.getElementById('shop-modal').classList.add('hidden');
        }

        function buyLife() {
            const cost = 10; // 10 gemas por vida
            if (userGems >= cost) {
                userGems -= cost;
                userLives += 1;
                saveProgress();
                document.getElementById('lives-count').textContent = userLives;
                document.getElementById('gems-count').textContent = userGems;
                showMessage(`¬°Has comprado 1 Vida! Vidas restantes: ${userLives} (+1)`, 'success');
                updatePracticeButtonState(currentTopicId); // Actualizar estado si las vidas estaban a 0
            } else {
                showMessage('¬°No tienes suficientes Gemas para comprar una Vida! üòî', 'error');
            }
        }


        // ====================================================================
        // 7. INICIALIZACI√ìN
        // ====================================================================

        window.onload = () => {
            initialSidebarSetup();
            // Inicia Firebase y carga el progreso autom√°ticamente
            initFirebase(); 
            // Inicializa la vista por defecto al mapa de aprendizaje
            renderLearningPath();
            document.getElementById('toggle-sidebar-btn').onclick = toggleSidebar;
            document.getElementById('close-mobile-sidebar').onclick = toggleSidebar;

             // Hacer la funci√≥n logout accesible globalmente
            window.logout = logout;
        };

        // Escucha el evento de redimensionamiento de ventana
        window.onresize = () => {
            if (window.innerWidth >= 768) {
                const sidebar = document.getElementById('sidebar');
                const mainContentArea = document.getElementById('main-content-area');
                // Al pasar a desktop, asegurar que sidebar tiene w-80 y main-content-area ml-80
                if (sidebar.classList.contains('w-20') || sidebar.classList.contains('-translate-x-full')) {
                     sidebar.classList.remove('w-20', 'fixed', '-translate-x-full');
                     sidebar.classList.add('w-80', 'md:relative', 'md:translate-x-0');
                     mainContentArea.classList.remove('md:ml-20');
                     mainContentArea.classList.add('md:ml-80');
                     document.getElementById('app').classList.remove('sidebar-collapsed');
                     isSidebarExpanded = true;
                }
            } else {
                // Modo m√≥vil: Si est√° expandido, debe estar en overlay
                 if (isSidebarExpanded) {
                    document.getElementById('sidebar').classList.remove('-translate-x-full');
                 } else {
                    document.getElementById('sidebar').classList.add('-translate-x-full');
                 }
                 document.getElementById('app').classList.remove('sidebar-collapsed');
            }
        };


    </script>
</head>
<body class="bg-gray-50 min-h-screen">

    <div id="message-bar" class="hidden fixed top-20 left-1/2 transform -translate-x-1/2 px-6 py-3 text-white font-semibold rounded-lg shadow-xl z-50 text-center transition-all duration-300">
        Mensaje de Estado
    </div>

    <header id="header" class="fixed top-0 left-0 w-full h-20 bg-white border-b border-gray-200 shadow-md z-30">
        <div class="h-full flex items-center justify-between px-4 md:px-6">
            <button id="toggle-sidebar-btn" class="text-indigo-600 md:hidden p-2 rounded-md hover:bg-gray-100 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                </svg>
            </button>

            <h1 id="header-title" class="text-xl md:text-2xl font-extrabold text-gray-800 flex-1 ml-4 md:ml-0 truncate">
                Curso Intensivo de Japon√©s para la Salud
            </h1>

            <div class="flex items-center space-x-4">
                <button onclick="openShopModal()" class="flex items-center p-2 rounded-full bg-red-100 text-red-600 hover:bg-red-200 transition-colors shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path d="M11.644 3.25c.524-.96 1.458-.96 1.982 0l3.882 7.152c.11.202.26.386.443.535l4.887 4.195a1.85 1.85 0 01-.89 3.251H2.766a1.85 1.85 0 01-.89-3.251l4.887-4.195a1.85 1.85 0 00.443-.535l3.882-7.152z" />
                    </svg>
                    <span id="lives-count" class="ml-2 font-bold text-lg">5</span>
                </button>

                <div class="flex items-center p-2 rounded-full bg-blue-100 text-blue-600 shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path fill-rule="evenodd" d="M11.54 22.351A2.174 2.174 0 0012 22.5c.27 0 .53-.081.74-.219L16.5 19.5 7.5 19.5l3.76-3.85c.19-.199.45-.301.74-.301s.55.102.74.301l.76 2.05h3.08a.75.75 0 010 1.5H16.5l-3.26 3.01zM4.17 14.5a.75.75 0 00.75-.75V8.5h15V13.75a.75.75 0 001.5 0V8.5a2.25 2.25 0 00-2.25-2.25h-15A2.25 2.25 0 003.5 8.5v5.25a.75.75 0 00.67.74zM12 7.5a.75.75 0 00-.75.75v3.75a.75.75 0 001.5 0V8.25a.75.75 0 00-.75-.75z" clip-rule="evenodd" />
                    </svg>
                    <span id="gems-count" class="ml-2 font-bold text-lg">0</span>
                </div>

                <button id="practice-button" onclick="markAsPracticed(currentTopicId)" class="hidden px-4 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition-colors shadow-lg">
                    Practicar Lecci√≥n
                </button>
            </div>
        </div>
    </header>

    <div id="app" class="flex min-h-screen">
        
        <nav id="sidebar" class="fixed md:relative w-80 h-full bg-white border-r border-gray-200 z-40 p-4 pt-8 overflow-y-auto flex-shrink-0 -translate-x-full md:translate-x-0">
            
            <div class="sticky top-0 bg-white pt-1 pb-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h2 id="sidebar-title" class="text-3xl font-extrabold text-indigo-700 transition-opacity duration-300">
                        Nihongo Pro
                    </h2>
                    <button id="toggle-icon" onclick="toggleSidebar()" class="hidden md:block p-1 text-gray-400 hover:text-gray-600 transition-transform duration-300">
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                            <path fill-rule="evenodd" d="M11.03 3.024a.75.75 0 01-.19.748L5.94 9.497l4.899 5.725a.75.75 0 11-1.138.972l-5.32-6.213a.75.75 0 010-.972l5.32-6.213a.75.75 0 01.94-.134z" clip-rule="evenodd" />
                            <path fill-rule="evenodd" d="M20.25 15.513l-4.898 5.725a.75.75 0 01-1.139-.972l5.32-6.213a.75.75 0 010-.972l-5.32-6.213a.75.75 0 111.139-.972l4.898 5.725a.75.75 0 01.19.748z" clip-rule="evenodd" />
                        </svg>
                    </button>
                     <button id="close-mobile-sidebar" class="md:hidden p-1 text-gray-400 hover:text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                            <path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 011.06 0L12 10.94l5.47-5.47a.75.75 0 111.06 1.06L13.06 12l5.47 5.47a.75.75 0 11-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 01-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 010-1.06z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="mt-4 space-y-3 pb-4 border-b border-gray-200">
                <a href="#" class="sidebar-text flex items-center p-2 rounded-lg manga-button manga-instagram bg-indigo-50 text-indigo-700 hover:bg-indigo-100 transition-all shadow-md">
                    <span class="text-xl font-mono">IG</span>
                    <span class="ml-3 font-bold">Instagram (Vocabulario)</span>
                </a>
                <a href="#" class="sidebar-text flex items-center p-2 rounded-lg manga-button manga-classroom bg-green-50 text-green-700 hover:bg-green-100 transition-all shadow-md">
                    <span class="text-xl font-mono">GC</span>
                    <span class="ml-3 font-bold">Google Classroom (Tareas)</span>
                </a>
                 <a href="#" class="sidebar-text flex items-center p-2 rounded-lg manga-button manga-duolingo bg-amber-50 text-amber-700 hover:bg-amber-100 transition-all shadow-md">
                    <span class="text-xl font-mono">DL</span>
                    <span class="ml-3 font-bold">Duolingo (Pr√°ctica Diaria)</span>
                </a>
            </div>

            <div id="topic-list" class="mt-4">
                </div>

            <div id="firebase-info" class="sidebar-text mt-6 text-xs text-gray-500 transition-opacity duration-300">
                <div class="font-bold text-gray-700">Perfil/Estado de la Sesi√≥n:</div>
                <p id="user-id-display" class="truncate">ID de Usuario: loading...</p>
                <p id="firebase-status" class="font-semibold mt-1">Desconectado</p>
                <button onclick="logout()" class="mt-2 w-full text-center py-1 text-sm bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors shadow-md">
                    Cerrar Sesi√≥n
                </button>
            </div>
        </nav>

        <main id="main-content-area" class="flex-1 transition-all duration-300 md:ml-80">
            <div class="p-4 md:p-8 pt-20">
                <div id="main-content-wrapper">
                    </div>
            </div>
        </main>
    </div>

    <div id="shop-modal" class="modal-overlay hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md mx-4 transform transition-all duration-300 scale-100">
            <h3 class="text-3xl font-bold text-indigo-700 mb-4 border-b pb-2">Tienda de Vidas ‚ù§Ô∏è</h3>
            <p class="text-gray-600 mb-6">Usa tus gemas (üíé) para reponer tus vidas (‚ù§Ô∏è) y seguir practicando.</p>
            
            <div class="p-4 border border-blue-200 bg-blue-50 rounded-lg flex items-center justify-between shadow-md">
                <div class="flex items-center space-x-3">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8 text-blue-500">
                        <path fill-rule="evenodd" d="M11.54 22.351A2.174 2.174 0 0012 22.5c.27 0 .53-.081.74-.219L16.5 19.5 7.5 19.5l3.76-3.85c.19-.199.45-.301.74-.301s.55.102.74.301l.76 2.05h3.08a.75.75 0 010 1.5H16.5l-3.26 3.01zM4.17 14.5a.75.75 0 00.75-.75V8.5h15V13.75a.75.75 0 001.5 0V8.5a2.25 2.25 0 00-2.25-2.25h-15A2.25 2.25 0 003.5 8.5v5.25a.75.75 0 00.67.74zM12 7.5a.75.75 0 00-.75.75v3.75a.75.75 0 001.5 0V8.25a.75.75 0 00-.75-.75z" clip-rule="evenodd" />
                    </svg>
                    <span class="text-2xl font-bold text-gray-800">1 Vida</span>
                </div>
                
                <button onclick="buyLife()" class="px-6 py-2 bg-indigo-500 text-white font-bold rounded-lg hover:bg-indigo-600 transition-colors shadow-md flex items-center space-x-2">
                    <span>Comprar</span>
                    <span class="ml-2 font-mono">10 üíé</span>
                </button>
            </div>

            <button onclick="closeShopModal()" class="mt-6 w-full py-2 text-gray-600 font-semibold rounded-lg hover:bg-gray-100 transition-colors">
                Cerrar Tienda
            </button>
        </div>
    </div>

</body>
</html>
