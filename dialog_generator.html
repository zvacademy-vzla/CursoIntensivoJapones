<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Di√°logos - Japon√©s M√©dico</title>
    <!-- Carga de Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilo para simular el chat/di√°logo */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Gray-100 */
        }
        .dialogue-line {
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            transition: transform 0.2s;
        }
        .dialogue-line:hover {
            transform: translateY(-1px);
        }
        .professional {
            background-color: #e0e7ff; /* Indigo-100 */
            border-left: 4px solid #4f46e5; /* Indigo-600 */
        }
        .patient {
            background-color: #fff;
            border-right: 4px solid #f97316; /* Orange-500 */
            margin-left: 10%; /* Offset para distinguir visualmente */
        }
        .speaker-tag {
            font-weight: bold;
            display: block;
            margin-bottom: 0.25rem;
        }
        .japanese-text {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* semibold */
            color: #1f2937; /* Gray-800 */
        }
        .romaji-text {
            font-style: italic;
            color: #4b5563; /* Gray-600 */
        }
        .spanish-text {
            font-size: 0.875rem; /* text-sm */
            color: #6b7280; /* Gray-500 */
            margin-top: 0.5rem;
            border-top: 1px dashed #d1d5db;
            padding-top: 0.5rem;
        }
    </style>
</head>
<body class="min-h-screen p-6 sm:p-10">

    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2">üó£Ô∏è Generador de Di√°logos M√©dicos</h1>
        <p class="text-gray-600 mb-8">Crea conversaciones realistas y personalizadas en japon√©s para practicar roles espec√≠ficos. Elige un escenario y la IA generar√° el di√°logo con su traducci√≥n y *romaji*.</p>

        <!-- Formulario de Entrada -->
        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-8">
            <h2 class="text-xl font-bold text-indigo-600 mb-4">Configurar Escenario</h2>
            
            <label for="scenarioInput" class="block text-sm font-medium text-gray-700 mb-2">Describe el escenario (Ej: Fisioterapeuta evaluando el dolor de rodilla de un paciente de 60 a√±os).</label>
            <textarea id="scenarioInput" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out" placeholder="Describe la situaci√≥n, los roles y el tema m√©dico..."></textarea>
            
            <button id="generateButton" onclick="generateDialogue()" class="mt-4 w-full sm:w-auto px-6 py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition duration-150 ease-in-out shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Generar Di√°logo
            </button>
        </div>

        <!-- √Årea de Resultados y Loading -->
        <div class="mt-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-4 border-b pb-2">Di√°logo Generado</h2>

            <!-- Indicador de Carga -->
            <div id="loadingIndicator" class="hidden flex flex-col items-center justify-center p-10 bg-white rounded-xl shadow-lg border border-gray-200">
                <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-indigo-500 border-gray-200 mb-4"></div>
                <p class="text-lg font-semibold text-gray-600">Generando conversaci√≥n biling√ºe...</p>
                <p class="text-sm text-gray-500 mt-2">Esto puede tomar unos segundos.</p>
            </div>

            <!-- Contenedor del Di√°logo -->
            <div id="dialogueOutput" class="space-y-4">
                <div id="initialMessage" class="bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 p-4 rounded-lg">
                    <p class="font-semibold">Esperando escenario...</p>
                    <p class="text-sm">Introduce un tema en el campo de arriba y haz clic en "Generar Di√°logo" para comenzar tu pr√°ctica.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n de la API de Gemini
        const API_KEY = ""; // Se inyecta en runtime
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        const MAX_RETRIES = 5;
        const BASE_DELAY_MS = 1000;

        /**
         * Funci√≥n principal para generar el di√°logo.
         */
        async function generateDialogue() {
            const scenario = document.getElementById('scenarioInput').value.trim();
            const outputDiv = document.getElementById('dialogueOutput');
            const loadingIndicator = document.getElementById('loadingIndicator');
            
            // OBTENER LA REFERENCIA DE LA MENSAJE INICIAL. PUEDE SER NULL SI YA SE ELIMIN√ì.
            const initialMessage = document.getElementById('initialMessage'); 

            if (!scenario) {
                alertUser('Por favor, describe un escenario para generar el di√°logo.', 'alert-error');
                return;
            }

            // FIX: Verificar si el elemento existe antes de intentar manipular su classList.
            if (initialMessage) {
                initialMessage.classList.add('hidden');
            }
            
            // Limpiar salida anterior y mostrar loading.
            outputDiv.innerHTML = '';
            loadingIndicator.classList.remove('hidden');

            const systemPrompt = `
                Eres un experto en idioma japon√©s y guionista de di√°logos m√©dicos. Tu tarea es crear una conversaci√≥n biling√ºe (Japon√©s, Romaji y Espa√±ol) para un profesional de la salud (rol: 'Professional') y un paciente (rol: 'Patient'). 
                El di√°logo debe ser formal, cort√©s, y contener de 8 a 12 intercambios.
                
                Instrucciones de formato estrictas:
                1. El di√°logo debe seguir la estructura: Professional -> Patient -> Professional -> Patient...
                2. Cada l√≠nea de di√°logo DEBE estar en una l√≠nea separada.
                3. Cada l√≠nea DEBE usar el formato exacto: **[ROL]: [Texto Japon√©s] / [Romaji] / [Traducci√≥n al Espa√±ol]**.
                4. Usa solo los roles 'Professional' y 'Patient'.
                
                Ejemplo de formato:
                Professional: „Åì„Çì„Å´„Å°„ÅØ„ÄÇÊãÖÂΩì„ÅÆÁêÜÂ≠¶ÁôÇÊ≥ïÂ£´„Åß„Åô„ÄÇ / Konnichiwa. Tant≈ç no rigaku ry≈çh≈çshi desu. / Buenos d√≠as. Soy el fisioterapeuta a cargo.
                Patient: „Çà„Çç„Åó„Åè„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô„ÄÇ / Yoroshiku onegai shimasu. / Encantado de conocerle.
            `;

            const userQuery = `Genera un di√°logo basado en el siguiente escenario: ${scenario}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const responseText = await fetchWithRetry(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = JSON.parse(responseText);
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text || "No se pudo generar el di√°logo. Intente con un escenario diferente.";
                
                renderDialogue(generatedText);

            } catch (error) {
                console.error("Error al generar el di√°logo:", error);
                alertUser('Error al comunicarse con la IA. Por favor, revise su conexi√≥n o intente de nuevo.', 'alert-error');
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }
        
        /**
         * Maneja las llamadas a la API con reintentos y retroceso exponencial.
         */
        async function fetchWithRetry(url, options, retryCount = 0) {
            try {
                const response = await fetch(url, options);
                
                if (!response.ok) {
                    if (response.status === 429 && retryCount < MAX_RETRIES) {
                        const delay = BASE_DELAY_MS * Math.pow(2, retryCount) + Math.random() * 1000;
                        console.log(`[RETRY] Tasa l√≠mite alcanzada. Reintentando en ${delay.toFixed(0)}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return fetchWithRetry(url, options, retryCount + 1);
                    }
                    // Capturar el cuerpo de la respuesta para ver el error real si no es 429
                    const errorBody = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}. Body: ${errorBody.substring(0, 100)}...`);
                }
                
                return response.text();

            } catch (error) {
                if (retryCount < MAX_RETRIES) {
                    const delay = BASE_DELAY_MS * Math.pow(2, retryCount) + Math.random() * 1000;
                    console.log(`[RETRY] Error de red. Reintentando en ${delay.toFixed(0)}ms...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(url, options, retryCount + 1);
                }
                throw new Error("Fallo en la conexi√≥n despu√©s de m√∫ltiples reintentos.");
            }
        }
        
        /**
         * Parsea el texto generado y lo renderiza en formato de chat.
         */
        function renderDialogue(text) {
            const outputDiv = document.getElementById('dialogueOutput');
            outputDiv.innerHTML = '';
            
            const lines = text.split('\n').filter(line => line.trim().length > 0);
            
            if (lines.length === 0) {
                alertUser('La IA gener√≥ una respuesta vac√≠a o ilegible. Intente de nuevo.', 'alert-error');
                return;
            }

            lines.forEach(line => {
                // Patr√≥n: ROL: [Texto Japon√©s] / [Romaji] / [Traducci√≥n al Espa√±ol]
                const match = line.match(/^(Professional|Patient):\s*([^/]+)\s*\/\s*([^/]+)\s*\/\s*(.+)$/i);

                if (match) {
                    const speaker = match[1].trim();
                    const japanese = match[2].trim();
                    const romaji = match[3].trim();
                    const spanish = match[4].trim();

                    const isProfessional = speaker.toLowerCase() === 'professional';
                    const className = isProfessional ? 'professional' : 'patient';
                    const tagColor = isProfessional ? 'text-indigo-600' : 'text-orange-600';

                    const dialogueElement = document.createElement('div');
                    dialogueElement.className = `dialogue-line ${className}`;
                    dialogueElement.innerHTML = `
                        <span class="speaker-tag ${tagColor}">${speaker.toUpperCase()}</span>
                        <div class="japanese-text mb-1">${japanese}</div>
                        <div class="romaji-text">${romaji}</div>
                        <div class="spanish-text">${spanish}</div>
                    `;
                    outputDiv.appendChild(dialogueElement);
                } else {
                    // Manejar l√≠neas que no coinciden con el formato esperado (ej. encabezados o errores de formato de la IA)
                    console.warn("L√≠nea no parseada, mostrada como texto simple:", line);
                    const errorElement = document.createElement('p');
                    errorElement.className = 'text-sm text-red-500 italic p-2 bg-red-50 rounded';
                    errorElement.textContent = `Error de formato en l√≠nea: ${line.substring(0, 80)}...`;
                    outputDiv.appendChild(errorElement);
                }
            });
        }

        /**
         * Funci√≥n para mostrar mensajes de alerta (sin usar alert()).
         * Adem√°s, reinserta el mensaje inicial de bienvenida si se genera un error.
         */
        function alertUser(message, type = 'alert-info') {
            const outputDiv = document.getElementById('dialogueOutput');
            
            // 1. Limpiar di√°logo anterior
            outputDiv.innerHTML = ''; 

            const colorMap = {
                'alert-error': 'bg-red-100 border-red-500 text-red-700',
                'alert-info': 'bg-blue-100 border-blue-500 text-blue-700'
            };

            // 2. Crear y a√±adir la alerta
            const alertElement = document.createElement('div');
            alertElement.className = `p-4 rounded-lg border-l-4 font-semibold ${colorMap[type] || colorMap['alert-info']} mb-4`;
            alertElement.textContent = message;
            outputDiv.appendChild(alertElement);
            
            // 3. Recrear y mostrar el mensaje inicial si es un error.
            if (type === 'alert-error') {
                 // Crear el elemento inicial de nuevo, ya que fue eliminado
                const initialMessage = document.createElement('div');
                initialMessage.id = 'initialMessage';
                initialMessage.className = 'bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 p-4 rounded-lg';
                initialMessage.innerHTML = `
                    <p class="font-semibold">Esperando escenario...</p>
                    <p class="text-sm">Introduce un tema en el campo de arriba y haz clic en "Generar Di√°logo" para comenzar tu pr√°ctica.</p>
                `;
                outputDiv.appendChild(initialMessage);
            }
        }

        // Se puede iniciar con un escenario de ejemplo precargado si se desea, pero por defecto se deja vac√≠o.
        document.getElementById('scenarioInput').value = 'Fisioterapeuta evaluando el dolor de espalda baja (ËÖ∞Áóõ - Y≈çts≈´) de un oficinista de mediana edad. La conversaci√≥n debe ser sobre la intensidad del dolor y el movimiento que lo agrava.';
    </script>
</body>
</html>
