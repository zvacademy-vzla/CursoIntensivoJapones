<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Diálogos Médicos en Japonés</title>
    <!-- Carga de Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Importaciones de Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Establecer nivel de log para depuración de Firebase
        setLogLevel('Debug');

        // --- 1. Variables Globales y Configuración ---
        
        // Se asume que las variables de entorno __app_id, __firebase_config y __initial_auth_token están disponibles
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // **CORRECCIÓN:** Usamos una configuración de respaldo más robusta para evitar fallos de inicialización.
        const FIREBASE_CONFIG_FALLBACK = {
            apiKey: "dummy-api-key",
            authDomain: "dummy-project.firebaseapp.com",
            projectId: "dummy-project",
            storageBucket: "dummy-project.appspot.com",
            messagingSenderId: "000000000000",
            appId: "1:000000000000:web:0000000000000000000000",
        };
        
        let firebaseConfig = null;
        try {
            // Intenta cargar desde la variable de entorno
            if (typeof __firebase_config !== 'undefined' && __firebase_config.length > 0) {
                firebaseConfig = JSON.parse(__firebase_config);
            } else {
                // Usa el fallback si la variable no existe o está vacía
                firebaseConfig = FIREBASE_CONFIG_FALLBACK;
            }
        } catch (e) {
            console.error("Error al parsear la configuración de Firebase. Usando fallback.", e);
            firebaseConfig = FIREBASE_CONFIG_FALLBACK;
        }

        let auth = null;
        let db = null;
        let currentUserId = null;

        // --- 2. Inicialización y Autenticación de Firebase ---

        /**
         * Inicializa Firebase y autentica al usuario.
         */
        async function initializeFirebaseAndAuth() {
            if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                 console.error("ERROR: Firebase Configuración faltante o vacía.");
                 document.getElementById('loading-state').textContent = 'Error: Configuración de Firebase no disponible.';
                 return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Autenticar
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token.length > 0) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                // Listener de estado de autenticación
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        document.getElementById('loading-state').classList.add('hidden');
                        document.getElementById('dialog-app-container').classList.remove('hidden');
                        console.log("Usuario autenticado con UID:", currentUserId);
                    } else {
                        currentUserId = null;
                        document.getElementById('loading-state').textContent = 'Esperando autenticación...';
                        document.getElementById('dialog-app-container').classList.add('hidden');
                    }
                });

            } catch (error) {
                console.error("Error en la inicialización de Firebase/Auth:", error);
                document.getElementById('loading-state').textContent = `Error de Autenticación: ${error.message}`;
            }
        }
        
        // --- 3. Funciones de Llamada a la API de Gemini (Módulo) ---

        /**
         * Llama a la API de Gemini para generar el diálogo estructurado.
         * @param {string} promptText - El prompt del usuario.
         * @param {string} userRole - El rol seleccionado por el usuario.
         * @returns {object} Objeto JSON con la conversación o null en caso de error.
         */
        async function generateDialogue(promptText, userRole) {
            const systemPrompt = `Eres un tutor de japonés experto en terminología médica y conversaciones de rol. Tu tarea es generar un diálogo realista y educativo entre dos personas. Uno de los roles debe ser el de ${userRole}. El diálogo debe enfocarse en la situación médica proporcionada. Siempre responde con una estructura JSON válida, incluyendo la traducción a español para cada turno.

Schema JSON requerido:
{
  "dialogueTitle": "Título de la conversación, preferiblemente en japonés y español.",
  "speakerA_role": "Rol del primer hablante (Ej: 医師 - Doctor, 患者 - Paciente, 理学療法士 - Fisioterapeuta)",
  "speakerB_role": "Rol del segundo hablante",
  "conversation": [
    {
      "speaker": "A",
      "japanese": "Frase de Speaker A en japonés.",
      "spanish": "Traducción de Speaker A en español."
    },
    {
      "speaker": "B",
      "japanese": "Frase de Speaker B en japonés.",
      "spanish": "Traducción de Speaker B en español."
    }
  ]
}
`;
            
            const payload = {
                contents: [{ parts: [{ text: promptText }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "dialogueTitle": { "type": "STRING" },
                            "speakerA_role": { "type": "STRING" },
                            "speakerB_role": { "type": "STRING" },
                            "conversation": {
                                "type": "ARRAY",
                                "items": {
                                    "type": "OBJECT",
                                    "properties": {
                                        "speaker": { "type": "STRING", "description": "A o B" },
                                        "japanese": { "type": "STRING" },
                                        "spanish": { "type": "STRING" }
                                    }
                                }
                            }
                        },
                        "required": ["dialogueTitle", "speakerA_role", "speakerB_role", "conversation"]
                    }
                }
            };

            const apiKey = ""; // Dejar vacío; Canvas lo proporciona automáticamente
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            for (let i = 0; i < 3; i++) { // Intentar 3 veces con backoff
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`Error HTTP: ${response.status}. Respuesta: ${errorBody}`);
                    }

                    const result = await response.json();
                    
                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (jsonText) {
                        return JSON.parse(jsonText);
                    }
                    
                    throw new Error("Respuesta del modelo incompleta o vacía.");
                } catch (error) {
                    console.error(`Intento ${i + 1} fallido:`, error.message);
                    if (i < 2) {
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000)); // Espera exponencial
                    } else {
                        return null; // Fallo después de todos los reintentos
                    }
                }
            }
        }
        
        // Hacemos la función global accesible al HTML
        window.generateDialogue = generateDialogue;

        // Iniciar Firebase al cargar el script
        initializeFirebaseAndAuth();
    </script>

    <style>
        /* Estilos personalizados */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        .dialogue-box {
            max-height: 70vh;
            overflow-y: auto;
            border-radius: 0.75rem;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
        }
        .speaker-a {
            background-color: #e0f2fe; /* Light Blue */
            border-left: 4px solid #0369a1; /* Darker Blue */
        }
        .speaker-b {
            background-color: #f0fdf4; /* Light Green */
            border-left: 4px solid #15803d; /* Darker Green */
        }
        .loading-animation {
            border-top-color: #3b82f6;
            animation: spinner 1s linear infinite;
        }
        @keyframes spinner {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">
    
    <!-- Estado de Carga / Autenticación -->
    <div id="loading-state" class="text-center p-8 text-gray-600">
        Cargando configuración de la aplicación y autenticando usuario...
        <div class="loading-animation border-4 border-gray-200 border-solid rounded-full w-8 h-8 mx-auto mt-4"></div>
    </div>

    <!-- Contenedor Principal de la Aplicación (Oculto hasta la autenticación) -->
    <div id="dialog-app-container" class="hidden max-w-4xl mx-auto bg-white p-6 md:p-8 rounded-2xl shadow-xl border border-gray-100">
        <header class="mb-6 border-b pb-4">
            <h1 class="text-3xl font-extrabold text-indigo-700">Generador de Diálogos Médicos (AI)</h1>
            <p class="text-gray-500 mt-1">Crea conversaciones realistas en japonés para practicar tu rol en el entorno de la salud.</p>
        </header>

        <!-- Formulario de Configuración de Diálogo -->
        <form id="dialog-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 p-4 bg-gray-50 rounded-lg border">
            
            <div>
                <label for="role" class="block text-sm font-medium text-gray-700 mb-1">Tu Rol:</label>
                <select id="role" name="role" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="Fisioterapeuta Japonés">理学療法士 (Fisioterapeuta)</option>
                    <option value="Doctor Japonés">医師 (Doctor)</option>
                    <option value="Enfermero Japonés">看護師 (Enfermero)</option>
                    <option value="Paciente Japonés">患者 (Paciente)</option>
                    <option value="Familiar de Paciente Japonés">患者の家族 (Familiar)</option>
                </select>
            </div>
            
            <div class="md:col-span-2">
                <label for="topic" class="block text-sm font-medium text-gray-700 mb-1">Tema / Situación Específica:</label>
                <input type="text" id="topic" name="topic" required placeholder="Ej: Explicar ejercicios de rehabilitación para dolor de rodilla" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            </div>

            <div>
                <label for="length" class="block text-sm font-medium text-gray-700 mb-1">Longitud:</label>
                <select id="length" name="length" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="corto (3-4 turnos)">Corto (3-4 turnos)</option>
                    <option value="medio (5-7 turnos)" selected>Medio (5-7 turnos)</option>
                    <option value="largo (8+ turnos)">Largo (8+ turnos)</option>
                </select>
            </div>
            
            <div class="flex items-end md:col-span-2">
                <button type="submit" id="generate-button" class="w-full p-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md">
                    Generar Diálogo
                </button>
            </div>
        </form>

        <!-- Área de Visualización de Diálogo -->
        <div class="mt-8">
            <h2 id="dialog-title" class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Diálogo Generado:</h2>
            <div id="dialog-output" class="dialogue-box bg-gray-100 p-4 space-y-4">
                <p class="text-center text-gray-500">Define los parámetros arriba y presiona "Generar Diálogo" para empezar.</p>
            </div>
        </div>

        <!-- Feedback de Errores y Carga -->
        <div id="feedback-message" class="mt-4 p-3 hidden rounded-lg font-medium"></div>

    </div>
    
    <script>
        // --- 4. Lógica de UI y Manejo de Eventos (Global) ---

        // Referencias a elementos del DOM
        const dialogForm = document.getElementById('dialog-form');
        const roleSelect = document.getElementById('role');
        const topicInput = document.getElementById('topic');
        const lengthSelect = document.getElementById('length');
        const generateButton = document.getElementById('generate-button');
        const dialogTitle = document.getElementById('dialog-title');
        const dialogOutput = document.getElementById('dialog-output');
        const feedbackMessage = document.getElementById('feedback-message');
        
        /**
         * Muestra un mensaje de feedback al usuario.
         * @param {string} message - El mensaje a mostrar.
         * @param {string} type - 'success', 'error', 'info', o 'loading'.
         */
        function showFeedback(message, type) {
            feedbackMessage.textContent = message;
            feedbackMessage.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700');
            
            if (type === 'error') {
                feedbackMessage.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                feedbackMessage.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'loading') {
                feedbackMessage.classList.add('bg-blue-100', 'text-blue-700');
            } else { // info
                feedbackMessage.classList.add('bg-gray-100', 'text-gray-700');
            }
            
            if (type !== 'loading') {
                generateButton.disabled = false;
                generateButton.textContent = 'Generar Diálogo';
            }
        }
        
        /**
         * Renderiza el diálogo generado en la interfaz.
         * @param {object} dialogueData - El objeto JSON de diálogo.
         */
        function renderDialogue(dialogueData) {
            dialogTitle.textContent = `Diálogo Generado: ${dialogueData.dialogueTitle || 'Sin título'}`;
            dialogOutput.innerHTML = '';
            
            dialogueData.conversation.forEach(turn => {
                // Determina el rol real basado en el hablante
                const isSpeakerA = turn.speaker === 'A';
                const role = isSpeakerA ? dialogueData.speakerA_role : dialogueData.speakerB_role;
                const speakerName = role.split('(')[0].trim(); // Intenta obtener solo el rol sin el japonés

                // Clases dinámicas
                const boxClasses = isSpeakerA ? 'speaker-a' : 'speaker-b';
                
                const turnElement = document.createElement('div');
                turnElement.className = `p-4 rounded-xl shadow-sm transition-all duration-300 ${boxClasses}`;
                turnElement.innerHTML = `
                    <p class="font-bold text-lg text-gray-800 mb-1">${speakerName} (${turn.speaker}):</p>
                    <div class="border-t border-gray-300 my-2"></div>
                    <p class="text-xl font-semibold text-gray-900">${turn.japanese}</p>
                    <p class="text-sm text-gray-600 italic mt-1">${turn.spanish}</p>
                `;
                dialogOutput.appendChild(turnElement);
            });
        }

        // Listener del formulario
        dialogForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            generateButton.disabled = true;
            generateButton.innerHTML = '<div class="loading-animation border-t-2 border-white border-solid rounded-full w-4 h-4 inline-block mr-2"></div> Generando...';
            showFeedback('Generando diálogo, por favor espera...', 'loading');
            dialogOutput.innerHTML = ''; // Limpiar salida anterior
            
            const userRole = roleSelect.value;
            const topic = topicInput.value;
            const length = lengthSelect.value;

            const promptText = `Crea un diálogo ${length} entre un ${userRole} y otra persona. El tema es: "${topic}". Asegúrate de que las frases sean naturales y apropiadas para el contexto médico en Japón.`;

            try {
                // Llamar a la función del módulo para generar el contenido
                const dialogueData = await window.generateDialogue(promptText, userRole);
                
                if (dialogueData) {
                    renderDialogue(dialogueData);
                    showFeedback('Diálogo generado con éxito.', 'success');
                } else {
                    throw new Error("El modelo no pudo generar un diálogo válido. Intenta un tema diferente.");
                }

            } catch (error) {
                console.error("Error en la generación de diálogo:", error);
                showFeedback(`Error: ${error.message}`, 'error');
                dialogOutput.innerHTML = '<p class="text-center text-red-500">No se pudo generar el diálogo. Por favor, revisa la consola para más detalles o intenta de nuevo.</p>';
            } finally {
                generateButton.disabled = false;
                generateButton.textContent = 'Generar Diálogo';
            }
        });

    </script>
</body>
</html>
