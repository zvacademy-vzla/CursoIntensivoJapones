<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Di√°logos de Rol M√©dico (Japon√©s)</title>
    <!-- Carga de Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos generales */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Gray-100 */
        }
        
        /* Estilos Espec√≠ficos del Di√°logo (Chat) */
        .dialogue-line {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        /* Estilo para el rol 'Professional' (Indigp) */
        .professional {
            background-color: #eef2ff; /* Indigo-50 */
            border-left: 5px solid #4f46e5; /* Indigo-600 */
            margin-right: 10%; 
        }
        /* Estilo para el rol 'Patient' (Orange) */
        .patient {
            background-color: #fff;
            border-right: 5px solid #f97316; /* Orange-500 */
            margin-left: 10%; 
        }
        .speaker-tag {
            font-weight: bold;
            display: block;
            margin-bottom: 0.25rem;
        }
        .japanese-text {
            font-size: 1.25rem; /* text-xl */
            font-weight: 700; /* bold */
            color: #1f2937; /* Gray-800 */
        }
        .romaji-text {
            font-style: italic;
            color: #4b5563; /* Gray-600 */
            margin-top: 0.25rem;
            font-size: 1rem;
        }
        .spanish-text {
            font-size: 0.875rem; /* text-sm */
            color: #6b7280; /* Gray-500 */
            margin-top: 0.75rem;
            border-top: 1px dashed #d1d5db;
            padding-top: 0.75rem;
        }
    </style>
</head>
<body class="p-6 md:p-10">

    <div class="max-w-4xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-2xl">
        <header class="mb-8 border-b pb-4">
            <div class="flex items-center space-x-3">
                <span class="text-5xl">üí¨üáØüáµ</span>
                <h1 class="text-3xl font-extrabold text-indigo-700">Generador de Di√°logos M√©dico-Japon√©s</h1>
            </div>
            <p class="text-gray-600 mt-2">Crea simulaciones de rol entre un **Profesional** de la salud y un **Paciente**. El di√°logo se genera en Japon√©s, Romaji y Espa√±ol.</p>
        </header>

        <!-- Formulario de Entrada del Di√°logo -->
        <div class="mb-10 p-6 bg-gray-50 rounded-lg border border-gray-200">
            <label for="scenarioInput" class="block text-lg font-bold text-gray-700 mb-3">Paso 1: Describe el Escenario M√©dico</label>
            <textarea id="scenarioInput" rows="4" class="w-full p-4 border-2 border-indigo-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out shadow-sm" placeholder="Ej: Fisioterapeuta pidiendo a un paciente que levante su rodilla (ËÜù - Hiza) para evaluar la amplitud de movimiento y el dolor. El paciente es anciano y cort√©s."></textarea>
            
            <button id="generateDialogueButton" onclick="generateDialogue()" class="mt-4 w-full sm:w-auto px-8 py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition duration-150 ease-in-out shadow-lg focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-indigo-500">
                Generar Di√°logo
            </button>
        </div>

        <!-- √Årea de Resultados y Loading -->
        <div class="mt-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b pb-2">Paso 2: Di√°logo de Pr√°ctica</h2>

            <!-- Indicador de Carga -->
            <div id="loadingIndicator" class="hidden flex flex-col items-center justify-center p-12 bg-indigo-50 rounded-xl border-2 border-indigo-200">
                <div class="animate-spin rounded-full h-16 w-16 border-4 border-t-4 border-indigo-600 border-indigo-200 mb-4"></div>
                <p class="text-xl font-semibold text-indigo-700">Generando conversaci√≥n biling√ºe...</p>
                <p class="text-md text-indigo-600 mt-2">Esto puede tomar unos segundos.</p>
            </div>

            <!-- Contenedor del Di√°logo -->
            <div id="dialogueOutput" class="space-y-4">
                <div id="initialMessage" class="bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 p-6 rounded-lg shadow-md">
                    <p class="font-bold text-lg">¬°Bienvenido!</p>
                    <p class="text-sm mt-1">Describe un escenario en el campo superior y pulsa **Generar Di√°logo** para recibir una conversaci√≥n de pr√°ctica profesional.</p>
                </div>
            </div>
        </div>
    </div>


    <script>
        // --- Configuraci√≥n de la API de Gemini ---
        // La API Key se proporciona en el entorno de ejecuci√≥n (Canvas)
        const API_KEY = typeof __api_key !== 'undefined' ? __api_key : ""; 
        const MODEL_NAME = "gemini-2.5-flash-preview-05-20";
        // La URL de la API se construye de forma din√°mica para asegurar que la clave est√© incluida si est√° disponible.
        const BASE_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent`;

        const MAX_RETRIES = 5;
        const BASE_DELAY_MS = 1000;
        
        // Asignar valor de ejemplo al cargar
        document.addEventListener('DOMContentLoaded', () => {
            const scenarioInput = document.getElementById('scenarioInput');
            if (scenarioInput.value.trim() === '') {
                scenarioInput.value = 'M√©dico (Professional) preguntando a un paciente (Patient) si ha tenido fiebre y d√≥nde siente el dolor en el est√≥mago.';
            }
        });


        /**
         * Funci√≥n principal para generar el di√°logo.
         */
        window.generateDialogue = async function() {
            const scenario = document.getElementById('scenarioInput').value.trim();
            const outputDiv = document.getElementById('dialogueOutput');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const initialMessage = document.getElementById('initialMessage'); 

            if (!scenario) {
                alertUser('Por favor, describe un escenario para generar el di√°logo.', 'alert-error');
                return;
            }

            if (!API_KEY) {
                alertUser('ERROR: No se pudo encontrar la clave de la API. El entorno de ejecuci√≥n no ha proporcionado la clave necesaria.', 'alert-error');
                return;
            }


            // Ocultar mensaje inicial y limpiar salida
            if (initialMessage) { initialMessage.classList.add('hidden'); }
            outputDiv.innerHTML = '';
            loadingIndicator.classList.remove('hidden');

            // Instrucci√≥n de sistema para forzar el formato estricto
            const systemPrompt = `
                Eres un experto en idioma japon√©s y guionista de di√°logos m√©dicos. Tu tarea es crear una conversaci√≥n biling√ºe (Japon√©s, Romaji y Espa√±ol) para un profesional de la salud (rol: 'Professional') y un paciente (rol: 'Patient'). 
                El di√°logo debe ser formal, cort√©s, y contener de 8 a 12 intercambios.
                
                Instrucciones de formato estrictas (IMPORTANTE):
                1. El di√°logo debe seguir la estructura: Professional -> Patient -> Professional -> Patient...
                2. Cada l√≠nea de di√°logo DEBE estar en una l√≠nea separada.
                3. Cada l√≠nea DEBE usar el formato exacto: **[ROL]: [Texto Japon√©s] / [Romaji] / [Traducci√≥n al Espa√±ol]**.
                4. Usa solo los roles 'Professional' y 'Patient'.
                5. NO uses caracteres de formato como asteriscos, negritas o n√∫meros en el output, solo el texto puro.
                
                Ejemplo de formato EXACTO:
                Professional: „Åì„Çì„Å´„Å°„ÅØ„ÄÇÊãÖÂΩì„ÅÆÁêÜÂ≠¶ÁôÇÊ≥ïÂ£´„Åß„Åô„ÄÇ / Konnichiwa. Tant≈ç no rigaku ry≈çh≈çshi desu. / Buenos d√≠as. Soy el fisioterapeuta a cargo.
            `;

            const userQuery = `Genera un di√°logo basado en el siguiente escenario: ${scenario}`;

            const payload = {
                contents: [{ 
                    parts: [{ text: userQuery }] 
                }],
                systemInstruction: { 
                    parts: [{ text: systemPrompt }] 
                },
                model: MODEL_NAME 
            };

            // Construir la URL completa con la clave de la API
            const finalApiUrl = `${BASE_API_URL}?key=${API_KEY}`;

            try {
                const responseText = await fetchWithRetry(finalApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = JSON.parse(responseText);
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text || "No se pudo generar el di√°logo. Intente con un escenario diferente.";
                
                renderDialogue(generatedText);

            } catch (error) {
                console.error("Error al generar el di√°logo:", error);
                alertUser(`Error de conexi√≥n o API: ${error.message}. Aseg√∫rese de que la clave de la API est√© disponible y el servicio est√© funcionando.`, 'alert-error');
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }
        
        /**
         * Maneja las llamadas a la API con reintentos y retroceso exponencial.
         */
        async function fetchWithRetry(url, options, retryCount = 0) {
            try {
                const response = await fetch(url, options);
                
                if (!response.ok) {
                    // Manejo de Tasa L√≠mite (429) y otros errores
                    if (response.status === 429 && retryCount < MAX_RETRIES) {
                        const delay = BASE_DELAY_MS * Math.pow(2, retryCount) + Math.random() * 1000;
                        console.warn(`429: Rate limit. Retrying in ${Math.round(delay)}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return fetchWithRetry(url, options, retryCount + 1);
                    }
                    const errorBody = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}. Detalle: ${errorBody.substring(0, 500)}...`);
                }
                
                return response.text();

            } catch (error) {
                if (retryCount < MAX_RETRIES) {
                    const delay = BASE_DELAY_MS * Math.pow(2, retryCount) + Math.random() * 1000;
                    console.error(`Fetch failed. Retrying in ${Math.round(delay)}ms...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(url, options, retryCount + 1);
                }
                throw new Error("Fallo en la conexi√≥n despu√©s de m√∫ltiples reintentos.");
            }
        }
        
        /**
         * Parsea el texto generado y lo renderiza en formato de chat.
         */
        function renderDialogue(text) {
            const outputDiv = document.getElementById('dialogueOutput');
            outputDiv.innerHTML = '';
            
            // Reemplazar saltos de l√≠nea y filtrar l√≠neas vac√≠as
            const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            
            if (lines.length === 0) {
                alertUser('La IA gener√≥ una respuesta vac√≠a o ilegible. Intente de nuevo.', 'alert-error');
                return;
            }

            lines.forEach(line => {
                // Patr√≥n: ROL: [Texto Japon√©s] / [Romaji] / [Traducci√≥n al Espa√±ol]
                const match = line.match(/^(Professional|Patient):\s*([^/]+)\s*\/\s*([^/]+)\s*\/\s*(.+)$/i);

                if (match) {
                    const speaker = match[1].trim();
                    const japanese = match[2].trim();
                    const romaji = match[3].trim();
                    const spanish = match[4].trim();

                    const isProfessional = speaker.toLowerCase() === 'professional';
                    const className = isProfessional ? 'professional' : 'patient';
                    const tagColor = isProfessional ? 'text-indigo-600' : 'text-orange-600';

                    const dialogueElement = document.createElement('div');
                    dialogueElement.className = `dialogue-line ${className}`;
                    dialogueElement.innerHTML = `
                        <span class="speaker-tag ${tagColor}">${speaker.toUpperCase()}</span>
                        <div class="japanese-text mb-1">${japanese}</div>
                        <div class="romaji-text">${romaji}</div>
                        <div class="spanish-text">${spanish}</div>
                    `;
                    outputDiv.appendChild(dialogueElement);
                } else {
                    // Si no se pudo parsear, mostrar la l√≠nea con un mensaje de error de formato
                    console.warn("L√≠nea no parseada (Formato incorrecto de la IA):", line);
                    const errorElement = document.createElement('div');
                    errorElement.className = 'p-4 rounded-lg bg-red-100 border-l-4 border-red-500 text-red-700 mb-4';
                    errorElement.innerHTML = `<p class="font-semibold">‚ö†Ô∏è Error de formato en la l√≠nea (La IA no sigui√≥ las instrucciones):</p><p class="mt-1 font-mono text-xs break-all">${line}</p>`;
                    outputDiv.appendChild(errorElement);
                }
            });
        }

        /**
         * Funci√≥n para mostrar mensajes de alerta o informaci√≥n.
         */
        function alertUser(message, type = 'alert-info') {
            const outputDiv = document.getElementById('dialogueOutput');
            outputDiv.innerHTML = ''; 

            const colorMap = {
                'alert-error': 'bg-red-100 border-red-500 text-red-700',
                'alert-info': 'bg-blue-100 border-blue-500 text-blue-700'
            };

            const alertElement = document.createElement('div');
            alertElement.className = `p-6 rounded-lg border-l-4 font-semibold ${colorMap[type] || colorMap['alert-info']} mb-4 shadow-md`;
            alertElement.innerHTML = `<p class="font-bold">${message}</p>`; // Usamos innerHTML para poder usar negritas en el mensaje.
            outputDiv.appendChild(alertElement);
            
            // Reinsertar el mensaje inicial despu√©s de la alerta
            const initialMessage = document.createElement('div');
            initialMessage.id = 'initialMessage';
            initialMessage.className = 'bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 p-6 rounded-lg shadow-md mt-4';
            initialMessage.innerHTML = `
                <p class="font-bold text-lg">Esperando escenario...</p>
                <p class="text-sm mt-1">Describe un escenario en el campo superior y pulsa **Generar Di√°logo** para comenzar tu pr√°ctica de rol.</p>
            `;
            outputDiv.appendChild(initialMessage);
        }
    </script>
</body>
</html>
